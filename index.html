<html>
<head>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/treeflex/dist/css/treeflex.css">
    <script src="https://cdn.jsdelivr.net/npm/enhance-object-property-names-getters"></script>
    <script src="https://cdn.jsdelivr.net/npm/treeify@1.1.0/treeify.js"></script>
    <style>
        #head {
            height: 30%;
        }
        #start {
            height: 50%;
            border-style: solid;
            margin: 20px;
            padding: 20px;
        }
    </style>
    <script>
        (function () {
            function isPrimitive(v) {
                if (null === v || undefined === v) {
                    return true;
                }
                if (['boolean', 'number', 'string'].includes(typeof v)) {
                    // return true;
                }
                return false;
            }

            const values = {};

            function main(start) {
                function getProp(val) {
                    switch (val) {
                        case Number.prototype:
                            return 'Number';
                        case Array.prototype:
                            return 'Array';
                        case Boolean.prototype:
                            return 'Boolean';
                        case String.prototype:
                            return 'String';
                        default:
                            return (val + '').split('[object ').join('').split(']').join('');
                    }
                }

                function cb(path) {
                    let node = root;
                    for (let i = 0; i < path.length; i++) {
                        const val = path[i];
                        const prop = getProp(val);
                        if (!node[prop]) {
                            id += 1;
                            values['b' + id] = val;
                            node[prop] = path.length - 1 === i ? null : {_value_reference: 'vf' + id};
                        }
                        node = node[prop];
                    }
                }

                const root = {};
                const props = Object.getAllPropertyNames(start);
                for (let i = 0; i < props.length; i++) {
                    const prop = props[i];
                    let obj = start[prop];
                    if (isPrimitive(obj)) continue;
                    const protos = [obj];
                    while (true) {
                        if (isPrimitive(obj)) break;
                        const proto = Object.getPrototypeOf(obj);
                        if (!proto) break;
                        protos.push(proto);
                        obj = proto;
                    }
                    protos.reverse();
                    cb(protos);
                }
                return root;
            }

            function includes(opts, prop) {
                prop = prop.split('filters=')[0];
                for (const filter of opts.filters) {
                    let found = false;
                    if (prop.includes(filter.filter)) {
                        found = true;
                    }
                    if (filter.not) {
                        found = !found;
                    }
                    if (found) {
                        return true;
                    }
                }
                return false;
            }

            let id = 0;

            function tree(node, obj, opts) {
                if (!obj) {
                    if (!node.parentElement.querySelector('[found="true"]')) {
                        node.parentElement.remove();
                    }
                }
                for (const prop in obj) {
                    if (prop === '_value_reference') continue;
                    const val = obj[prop];
                    id += 1;
                    node.innerHTML += `<li><span found="${includes(opts, prop, obj.value)}" class="tf-nc">${prop}</span><ul id="${'id' + id}"></ul></li>`;
                    tree(node.querySelector('#' + 'id' + id), val, opts);
                }
                if (!node.parentElement?.querySelector('[found="true"]')) {
                    node.parentElement?.remove();
                }
            }

            function opts(queryString) {
                const opts = {filters: []};
                const urlParams = new URLSearchParams(queryString);
                const filters = urlParams.get('filters');
                for (const filter of filters.split(',')) {
                    const f = { not: false, filter };
                    if (filter[0] === '!') {
                        f.not = true;
                        f.filter = filter.split('!').join('');
                    }
                    opts.filters.push(f);
                }
                return opts;
            }

            function getLayers(start) {
                const layers = {
                    1: [],
                    2: [],
                    3: [],
                    4: [],
                    5: [],
                    6: [],
                    7: [],
                    8: [],
                    9: [],
                    10: [],
                    11: [],
                    12: [],
                }
                const spans = start.querySelectorAll('span');
                for (let i = 0; i < spans.length; i++) {
                    const span = spans[i];
                    let d = -1, s = span;
                    while (s !== start) {
                        d += 1;
                        s = s.parentElement;
                    }
                    layers[d/2].push(span);
                }
                return layers;
            }

            function prepareMenu(menu, layers, max = 12) {
                const ul = document.createElement('ul');
                const li = document.createElement('li');
                for (const level in layers) {
                    if (!max) continue;
                    max -= 1;
                    const layer = layers[level];
                    for (let i = 0; i < layer.length; i++) {
                        const span = layer[i];
                        const a = document.createElement('a');
                        a.textContent = span.textContent;
                        a.href = 'javascript:;';
                        a.onclick = () => span.scrollIntoView({behavior: 'smooth'})
                        li.appendChild(a);
                        li.append(' | ');
                        if (li.children.length % 9 === 0) {
                            li.appendChild(document.createElement('br'));
                        }
                    }
                    ul.appendChild(li);
                }
                li.lastChild.remove();
                li.append(' (shortcuts to first couple of levels in the tree)');
                menu.appendChild(ul);
            }

            setTimeout(function () {
                const root = main(window);
                console.log('%cüëÄ Observe full live tree representing the full prototype chain:', 'color:deepskyblue');
                console.log(root);
                console.log('%cüó∫Ô∏è Map each entry in the full tree above to its real actual object in runtime:', 'color:deepskyblue');
                console.log(values);
                console.log('%cüëÄ Observe the full tree visually', 'color:deepskyblue');
                console.log(treeify.asTree(root));
                console.log('%cüëÜüèª Begin at the top of the console üëÜüèª', 'color:deepskyblue');
                const e = document.createElement('ul');
                tree(e, root, opts(window.location.search));
                start.appendChild(e);
                start.setAttribute('class', 'tf-tree');
                const layers = getLayers(start);
                prepareMenu(menu, layers, 2);
            });
        }())
    </script>
</head>
<body>
    <div style="padding: 10px;">
        <div id="head">
            <div id="menu"></div>
            test test test
        </div>
        <div id="start"></div>
    </div>
</body>
</html>